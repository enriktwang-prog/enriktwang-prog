<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enrik‚Äôs Comic Quest HQ ‚öΩüéÆüé®üéµ</title>
  <style>
    :root{
      --bg:#070a17;
      --card:#0f1533;
      --card2:#0b1130;
      --text:#e9efff;
      --muted:#a6b4ea;
      --line:rgba(255,255,255,.12);
      --accent:#7c5cff;
      --accent2:#00d4ff;
      --good:#55efc4;
      --warn:#ffeaa7;
      --bad:#ff7675;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 15% 0%, rgba(124,92,255,.28), transparent 60%),
        radial-gradient(760px 420px at 85% 10%, rgba(0,212,255,.18), transparent 60%),
        radial-gradient(1000px 600px at 40% 110%, rgba(85,239,196,.12), transparent 60%),
        var(--bg);
      min-height:100vh;
      overflow-x:hidden;
    }
    header{
      position:sticky; top:0; z-index:10;
      background: rgba(7,10,23,.70);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px;}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
      font-weight:1000;
      letter-spacing:.2px;
    }
    .chips{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .chip{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-weight:900;
      font-size:12.5px;
      white-space:nowrap;
    }
    .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; margin-top:14px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .in{padding:16px;}
    h1{margin:0 0 8px; font-size: clamp(26px, 4vw, 44px);}
    h2{margin:0 0 10px; font-size:18px;}
    p{margin:0; color:var(--muted); line-height:1.5;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}

    button{
      appearance:none; border:none; cursor:pointer;
      padding:11px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:1000;
      letter-spacing:.2px;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
      user-select:none;
    }
    button:hover{background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.26);}
    button:active{transform: translateY(1px) scale(.99);}
    button:disabled{opacity:.45; cursor:not-allowed;}

    .btnA{background: rgba(124,92,255,.20); border-color: rgba(124,92,255,.40);}
    .btnA:hover{background: rgba(124,92,255,.28); border-color: rgba(124,92,255,.55);}
    .btnB{background: rgba(0,212,255,.14); border-color: rgba(0,212,255,.32);}
    .btnB:hover{background: rgba(0,212,255,.20); border-color: rgba(0,212,255,.48);}
    .btnG{background: rgba(85,239,196,.14); border-color: rgba(85,239,196,.32);}
    .btnG:hover{background: rgba(85,239,196,.20); border-color: rgba(85,239,196,.48);}
    .btnW{background: rgba(255,234,167,.12); border-color: rgba(255,234,167,.28);}
    .btnW:hover{background: rgba(255,234,167,.18); border-color: rgba(255,234,167,.45);}
    .btnR{background: rgba(255,118,117,.10); border-color: rgba(255,118,117,.22);}
    .btnR:hover{background: rgba(255,118,117,.16); border-color: rgba(255,118,117,.38);}

    .span12{grid-column: span 12;}
    .span7{grid-column: span 7;}
    .span5{grid-column: span 5;}
    .span6{grid-column: span 6;}
    @media (max-width: 920px){
      .span7,.span5,.span6{grid-column: span 12;}
    }

    .meter{margin-top:12px; height:14px; border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.06); overflow:hidden;}
    .bar{height:100%; width:40%; border-radius:999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2), var(--good));
      transition: width .25s ease;}
    .meterline{display:flex; justify-content:space-between; margin-top:8px;
      font-weight:900; color:var(--muted); font-size:12.5px;}

    /* Comic */
    .comic{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 920px){ .comic{grid-template-columns:1fr;} }
    .panel{
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      padding:12px;
      min-height:120px;
      position:relative;
      overflow:hidden;
    }
    .panel b{display:block; margin-bottom:6px;}
    .speech{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      padding:10px;
      color:var(--text);
      line-height:1.35;
      min-height:54px;
    }
    .spark{
      position:absolute; right:-40px; bottom:-40px;
      width:140px; height:140px;
      background: radial-gradient(circle at 30% 30%, rgba(124,92,255,.55), transparent 60%);
      filter: blur(2px);
      opacity:.8;
      pointer-events:none;
    }

    /* Drawing */
    .canvasWrap{
      display:grid;
      grid-template-columns: 1fr 260px;
      gap:12px;
      align-items:start;
      margin-top:12px;
    }
    @media (max-width: 920px){ .canvasWrap{grid-template-columns:1fr;} }
    canvas{
      width:100%;
      height:320px;
      background:#070b1d;
      border-radius:16px;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      display:block;
    }
    .tools{
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:12px;
    }
    label{
      display:block;
      margin-top:8px;
      margin-bottom:6px;
      font-size:12.5px;
      color:var(--muted);
      font-weight:1000;
    }
    select, input[type="text"], input[type="range"]{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color:var(--text);
      padding:10px;
      outline:none;
      font-weight:900;
    }
    .hint{margin-top:10px; font-size:12.5px; color:var(--muted); line-height:1.45;}

    /* Battle */
    .battleGrid{display:grid; grid-template-columns: 1fr 1fr; gap:14px;}
    @media (max-width: 920px){ .battleGrid{grid-template-columns:1fr;} }
    .pane{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.14);
      padding:14px;
      position:relative;
      overflow:hidden;
      min-height: 230px;
    }
    .nameRow{display:flex; gap:10px; align-items:center;}
    .avatar{
      width:58px; height:58px; border-radius:16px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-size:30px;
      box-shadow: 0 10px 28px rgba(0,0,0,.22);
    }
    .who{font-weight:1100;}
    .sub{font-size:12.5px; color:var(--muted); font-weight:900; margin-top:2px;}
    .bars{margin-top:10px;}
    .barWrap{
      height:12px; border-radius:999px; overflow:hidden;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      margin-top:6px;
    }
    .barFill{height:100%; width:50%; border-radius:999px; transition:width .25s ease;}
    .hp{background: linear-gradient(90deg, var(--good), #9cffde);}
    .en{background: linear-gradient(90deg, var(--accent2), #7cf7ff);}
    .sh{background: linear-gradient(90deg, rgba(255,255,255,.35), rgba(255,255,255,.12));}
    .barLine{display:flex; justify-content:space-between; margin-top:8px; font-size:12.5px; color:var(--muted); font-weight:1000;}
    .log{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
      height: 220px;
      overflow:auto;
      font-size:13px;
      line-height:1.35;
      color: var(--text);
    }
    .tag{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size:11.5px;
      color:var(--muted);
      margin-right:6px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(15,21,51,.90);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: 0 16px 50px rgba(0,0,0,.40);
      color:var(--text);
      font-weight:1100;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:999;
      max-width: calc(100vw - 24px);
      text-align:center;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-4px);}

    footer{padding:22px 18px; text-align:center; color: rgba(233,239,255,.65); font-size:12.5px;}
  </style>
</head>
<body>
  <header>
    <div class="wrap top">
      <div class="brand">‚ö° Enrik‚Äôs Comic Quest HQ</div>
      <div class="chips">
        <div class="chip">‚≠ê Level: <span id="lvl">1</span></div>
        <div class="chip">‚ú® XP: <span id="xp">0</span></div>
        <div class="chip">üí• Power: <span id="powNum">40</span>%</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <!-- HERO -->
      <div class="card span7">
        <div class="in">
          <h1>Welcome, Enrik! ‚öΩüéÆüé®üéµ</h1>
          <p>
            Create comics, draw characters, and start battles with ‚ÄúBattle Init‚Äù.
            (Pirate/dragon vibes + soccer + music power ‚Äî without using any copyrighted characters.)
          </p>

          <div class="row">
            <button class="btnG" id="btnMission">NEW MISSION üéØ</button>
            <button class="btnA" id="btnPower">POWER UP ‚ö°</button>
            <button class="btnB" id="btnSurprise">SURPRISE üéÅ</button>
          </div>

          <div class="meter"><div class="bar" id="powBar"></div></div>
          <div class="meterline"><span>Power Meter</span><span id="powTxt">40%</span></div>

          <div class="row" style="margin-top:14px">
            <div class="chip">üè¥‚Äç‚ò†Ô∏è Pirate vibes</div>
            <div class="chip">üêâ Dragon vibes</div>
            <div class="chip">ü•Å Drums</div>
            <div class="chip">üéª Violin</div>
            <div class="chip">üé∏ Guitar</div>
            <div class="chip">üéµ Perfect pitch</div>
          </div>
        </div>
      </div>

      <!-- MISSION BOARD -->
      <div class="card span5">
        <div class="in">
          <h2>üìå Mission Board</h2>
          <p id="missionTxt">Tap <b>NEW MISSION</b> to begin.</p>
          <div class="row">
            <button id="btnDone">MISSION COMPLETE ‚úÖ</button>
            <button class="btnR" id="btnReset">RESET üîÑ</button>
          </div>
          <p class="hint">Tip: every click shows a toast at the bottom, so you know it worked.</p>
        </div>
      </div>

      <!-- COMICS -->
      <div class="card span12">
        <div class="in">
          <h2>üñºÔ∏è Comic Strip Studio</h2>
          <p>Create a 3-panel comic. Write it yourself or auto-generate a story.</p>

          <div class="comic">
            <div class="panel">
              <div class="spark"></div>
              <b>Panel 1</b>
              <div class="speech" id="p1">‚ÄúKickoff‚Ä¶ the hero steps onto the field.‚Äù</div>
            </div>
            <div class="panel">
              <div class="spark"></div>
              <b>Panel 2</b>
              <div class="speech" id="p2">‚ÄúA mysterious rival appears with a power aura!‚Äù</div>
            </div>
            <div class="panel">
              <div class="spark"></div>
              <b>Panel 3</b>
              <div class="speech" id="p3">‚ÄúPerfect Pitch POWER MOVE! Goal!!!‚Äù</div>
            </div>
          </div>

          <div class="row">
            <button class="btnB" id="btnAutoComic">AUTO STORY üìö</button>
            <button class="btnW" id="btnRandomCaption">RANDOM CAPTION ‚úçÔ∏è</button>
          </div>

          <div class="canvasWrap">
            <canvas id="board"></canvas>

            <div class="tools">
              <h2 style="margin-bottom:6px">Tools</h2>

              <label for="brush">Brush size</label>
              <input id="brush" type="range" min="2" max="26" value="8" />

              <label for="color">Color</label>
              <select id="color">
                <option value="#e9efff">Ice White</option>
                <option value="#7c5cff">Power Purple</option>
                <option value="#00d4ff">Neon Blue</option>
                <option value="#55efc4">Mint Green</option>
                <option value="#ffeaa7">Golden</option>
                <option value="#ff7675">Red Blast</option>
              </select>

              <div class="row" style="margin-top:10px">
                <button id="btnClear">CLEAR üßº</button>
                <button class="btnA" id="btnStamp">STAMP ‚≠ê</button>
              </div>

              <label for="line1">Panel 1 text</label>
              <input id="line1" type="text" maxlength="90" placeholder="Type your line..." />

              <label for="line2">Panel 2 text</label>
              <input id="line2" type="text" maxlength="90" placeholder="Type your line..." />

              <label for="line3">Panel 3 text</label>
              <input id="line3" type="text" maxlength="90" placeholder="Type your line..." />

              <div class="row" style="margin-top:10px">
                <button class="btnG" id="btnSetComic">SET PANELS ‚úÖ</button>
              </div>

              <p class="hint">Mouse: click+drag. Phone/iPad: draw with finger.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- BATTLE INIT -->
      <div class="card span12">
        <div class="in">
          <h2>‚öîÔ∏è Battle Init Arena</h2>
          <p>Pick a hero class and battle an enemy. Turn-based, kid-friendly, no gore.</p>

          <div class="row">
            <button class="btnG" id="btnStartBattle">START BATTLE INIT ‚ñ∂</button>
            <button id="btnNewEnemy">NEW ENEMY üé≤</button>
          </div>

          <div class="battleGrid" style="margin-top:12px">
            <!-- HERO -->
            <div class="pane">
              <div class="nameRow">
                <div class="avatar" id="heroIcon">üéµ</div>
                <div>
                  <div class="who" id="heroName">Enrik</div>
                  <div class="sub" id="heroClass">Sound Mage (Perfect Pitch)</div>
                </div>
              </div>

              <div class="row" style="margin-top:10px">
                <button class="btnB" id="pickStriker">‚öΩ Striker</button>
                <button class="btnA" id="pickMage">üéµ Sound Mage</button>
                <button class="btnG" id="pickBuilder">üéÆ Builder</button>
              </div>

              <div class="bars">
                <div class="barLine"><span>HP</span><span id="hHpTxt">100/100</span></div>
                <div class="barWrap"><div class="barFill hp" id="hHpBar"></div></div>

                <div class="barLine"><span>Energy</span><span id="hEnTxt">50/50</span></div>
                <div class="barWrap"><div class="barFill en" id="hEnBar"></div></div>

                <div class="barLine"><span>Shield</span><span id="hShTxt">0</span></div>
                <div class="barWrap"><div class="barFill sh" id="hShBar"></div></div>
              </div>

              <div class="row" style="margin-top:14px">
                <button class="btnB" id="actAttack">ATTACK ‚öîÔ∏è</button>
                <button class="btnA" id="actSkill">SKILL ‚ö°</button>
                <button class="btnG" id="actHeal">HEAL üß™</button>
                <button class="btnW" id="actDefend">DEFEND üõ°Ô∏è</button>
              </div>

              <p class="hint" id="turnHint">Press START BATTLE INIT to begin.</p>
            </div>

            <!-- ENEMY + LOG -->
            <div class="pane">
              <div class="nameRow">
                <div class="avatar" id="eIcon">üü£</div>
                <div>
                  <div class="who" id="eName">Slime Boss</div>
                  <div class="sub" id="eType">Enemy</div>
                </div>
              </div>

              <div class="bars">
                <div class="barLine"><span>HP</span><span id="eHpTxt">90/90</span></div>
                <div class="barWrap"><div class="barFill hp" id="eHpBar"></div></div>

                <div class="barLine"><span>Energy</span><span id="eEnTxt">40/40</span></div>
                <div class="barWrap"><div class="barFill en" id="eEnBar"></div></div>

                <div class="barLine"><span>Shield</span><span id="eShTxt">0</span></div>
                <div class="barWrap"><div class="barFill sh" id="eShBar"></div></div>
              </div>

              <div class="log" id="log"></div>
            </div>
          </div>
        </div>
      </div>

    </section>
  </main>

  <footer>Made for Enrik ‚ö° Create comics, play games, and keep the beat üéµ</footer>
  <div class="toast" id="toast">Ready</div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const $ = (id)=>document.getElementById(id);

      // ----- Toast -----
      const toast = $("toast");
      function showToast(msg){
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(()=>toast.classList.remove("show"), 1200);
      }

      // ----- Meta stats -----
      let level = 1, xp = 0, power = 40;
      function setPower(v){
        power = Math.max(0, Math.min(100, v));
        $("powBar").style.width = power + "%";
        $("powTxt").textContent = power + "%";
        $("powNum").textContent = power;
      }
      function addXP(n){
        xp += n;
        const need = 25 * level;
        if(xp >= need){
          xp -= need;
          level++;
          showToast("LEVEL UP! ‚≠ê");
        }
        $("lvl").textContent = level;
        $("xp").textContent = xp;
      }
      setPower(40);
      $("lvl").textContent = level;
      $("xp").textContent = xp;

      // ----- Mission board -----
      const missions = [
        "‚öΩ 20 toe taps + victory pose.",
        "üéÆ Roblox: design an obby with 3 obstacles + boss room.",
        "üé® Draw a 3-panel comic: hero ‚Üí problem ‚Üí win.",
        "ü•Å Make a beat: slow 8 counts, fast 8 counts.",
        "üé∏/üéª Create a 5-note melody (perfect pitch bonus!).",
        "üè¥‚Äç‚ò†Ô∏è Pirate vibe: write a 2-line adventure.",
        "üêâ Dragon vibe: invent a new energy attack name."
      ];
      function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

      $("btnMission").addEventListener("click", () => {
        $("missionTxt").textContent = rand(missions);
        addXP(5);
        setPower(power + 8);
        showToast("New mission!");
      });
      $("btnPower").addEventListener("click", () => {
        setPower(power + 18);
        addXP(3);
        showToast("Power up!");
      });
      $("btnSurprise").addEventListener("click", () => {
        const s = rand([
          "üéÅ Surprise: +1 Confidence Cape",
          "üéÅ Surprise: +1 Speed Boots",
          "üéÅ Surprise: +1 Music Aura",
          "üéÅ Surprise: +1 Comic Ink Pen",
          "üéÅ Surprise: +1 Builder Badge"
        ]);
        $("missionTxt").textContent = s;
        addXP(4);
        setPower(power + 6);
        showToast("Surprise!");
      });
      $("btnDone").addEventListener("click", () => {
        $("missionTxt").textContent = "‚úÖ Mission complete! XP earned.";
        addXP(10);
        setPower(power + 6);
        showToast("+10 XP!");
      });
      $("btnReset").addEventListener("click", () => {
        level = 1; xp = 0; setPower(40);
        $("lvl").textContent = level;
        $("xp").textContent = xp;
        $("missionTxt").innerHTML = 'Tap <b>NEW MISSION</b> to begin.';
        showToast("Reset!");
      });

      // ----- Comic maker -----
      $("btnAutoComic").addEventListener("click", () => {
        const a = [
          "‚ÄúKickoff‚Ä¶ the hero arrives with pirate energy!‚Äù",
          "‚ÄúIn Roblox City, the field turns into a boss arena!‚Äù",
          "‚ÄúA drumbeat starts‚Ä¶ and the ball begins to glow!‚Äù"
        ];
        const b = [
          "‚ÄúA dragon rival blocks the shot with an aura shield!‚Äù",
          "‚ÄúThe mysterious defender uses the Ultimate Tackle!‚Äù",
          "‚ÄúA portal opens‚Äîinstant obstacle course chaos!‚Äù"
        ];
        const c = [
          "‚ÄúPerfect Pitch POWER! The melody unlocks the winning move!‚Äù",
          "‚ÄúENERGY STRIKE! Goal + fireworks + victory dance!‚Äù",
          "‚ÄúTEAM COMBO! Assist ‚Üí volley ‚Üí WIN!‚Äù"
        ];
        $("p1").textContent = rand(a);
        $("p2").textContent = rand(b);
        $("p3").textContent = rand(c);
        addXP(5);
        showToast("Story generated!");
      });

      const captions = [
        "‚ÄúNo way‚Ä¶ that‚Äôs my ball!‚Äù",
        "‚ÄúActivate: Turbo Dribble!‚Äù",
        "‚ÄúI trained for this!‚Äù",
        "‚ÄúBoss incoming‚Ä¶ stay calm!‚Äù",
        "‚ÄúPerfect pitch‚Ä¶ CHARGE!‚Äù",
        "‚ÄúWe win as a team!‚Äù"
      ];
      $("btnRandomCaption").addEventListener("click", () => {
        const pick = rand([$("p1"), $("p2"), $("p3")]);
        pick.textContent = rand(captions);
        addXP(2);
        showToast("Caption swapped!");
      });

      $("btnSetComic").addEventListener("click", () => {
        const l1 = $("line1").value.trim();
        const l2 = $("line2").value.trim();
        const l3 = $("line3").value.trim();
        if(l1) $("p1").textContent = l1;
        if(l2) $("p2").textContent = l2;
        if(l3) $("p3").textContent = l3;
        addXP(4);
        showToast("Comic updated!");
      });

      // ----- Drawing canvas (robust on all screens) -----
      const canvas = $("board");
      const ctx = canvas.getContext("2d");
      function fitCanvas(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.round(rect.width * dpr);
        canvas.height = Math.round(rect.height * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
      }
      fitCanvas();
      window.addEventListener("resize", fitCanvas);

      let drawing = false;
      let last = {x:0, y:0};

      function pos(e){
        const rect = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: cx - rect.left, y: cy - rect.top };
      }
      function start(e){ drawing = true; last = pos(e); e.preventDefault(); }
      function move(e){
        if(!drawing) return;
        const p = pos(e);
        ctx.strokeStyle = $("color").value;
        ctx.lineWidth = Number($("brush").value);
        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        last = p;
        e.preventDefault();
      }
      function end(){ if(!drawing) return; drawing = false; addXP(1); }

      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("mousemove", move);
      window.addEventListener("mouseup", end);
      canvas.addEventListener("touchstart", start, {passive:false});
      canvas.addEventListener("touchmove", move, {passive:false});
      window.addEventListener("touchend", end);

      $("btnClear").addEventListener("click", () => {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        setPower(power - 3);
        showToast("Cleared!");
      });

      function drawStar(cx, cy, spikes, outerR, innerR, fill){
        let rot = Math.PI / 2 * 3, x = cx, y = cy;
        const step = Math.PI / spikes;
        ctx.beginPath();
        ctx.moveTo(cx, cy - outerR);
        for(let i=0;i<spikes;i++){
          x = cx + Math.cos(rot) * outerR;
          y = cy + Math.sin(rot) * outerR;
          ctx.lineTo(x,y);
          rot += step;
          x = cx + Math.cos(rot) * innerR;
          y = cy + Math.sin(rot) * innerR;
          ctx.lineTo(x,y);
          rot += step;
        }
        ctx.closePath();
        ctx.fillStyle = fill;
        ctx.globalAlpha = 0.85;
        ctx.fill();
        ctx.globalAlpha = 1;
      }
      $("btnStamp").addEventListener("click", () => {
        const rect = canvas.getBoundingClientRect();
        const x = 30 + Math.random()*(rect.width-60);
        const y = 30 + Math.random()*(rect.height-60);
        drawStar(x,y,5,18,8,$("color").value);
        addXP(2);
        showToast("Stamped!");
      });

      // ======================
      // Battle Init mini-game
      // ======================
      const logEl = $("log");
      function log(tag, msg){
        const line = document.createElement("div");
        line.innerHTML = `<span class="tag">${tag}</span>${msg}`;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
      }
      function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
      function rnd(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
      function chance(p){ return Math.random() < p; }

      const enemies = [
        {name:"Slime Boss", icon:"üü£", hp:90, atk:11, skl:15},
        {name:"Robo-Guard", icon:"ü§ñ", hp:120, atk:13, skl:17},
        {name:"Dragon Drone", icon:"üêâ", hp:150, atk:15, skl:20},
      ];

      let hero = null, enemy = null;
      let heroTurn = true;
      let battleOn = false;
      let heroFocus = 0;

      const heroClasses = {
        striker: {name:"Striker", icon:"‚öΩ", atkMul:1.15, sklMul:1.00, defMul:1.00},
        mage:    {name:"Sound Mage (Perfect Pitch)", icon:"üéµ", atkMul:1.00, sklMul:1.28, defMul:1.00},
        builder: {name:"Builder", icon:"üéÆ", atkMul:1.00, sklMul:1.10, defMul:1.18},
      };
      let currentClass = "mage";

      function buildHero(){
        const c = heroClasses[currentClass];
        const hpMax = 100 + (level-1)*10;
        const enMax = 50 + (level-1)*3;
        return {
          name:"Enrik",
          cls:c.name,
          icon:c.icon,
          hpMax, hp:hpMax,
          enMax, en:enMax,
          shield:0,
          atkBase: Math.round((12 + (level-1)*2) * c.atkMul),
          sklBase: Math.round((20 + (level-1)*3) * c.sklMul),
          defBase: Math.round(10 * c.defMul),
          healBase: 18 + (level-1)*2,
        };
      }
      function buildEnemy(e){
        // slight scaling with level
        const hpMax = e.hp + (level-1)*12;
        const enMax = 40 + (level-1)*4;
        return { ...e, hpMax, hp:hpMax, enMax, en:enMax, shield:0 };
      }

      function updateBattleUI(){
        $("heroIcon").textContent = hero.icon;
        $("heroName").textContent = hero.name;
        $("heroClass").textContent = hero.cls;

        $("eIcon").textContent = enemy.icon;
        $("eName").textContent = enemy.name;

        const hhp = (hero.hp/hero.hpMax)*100;
        const hen = (hero.en/hero.enMax)*100;
        const ehp = (enemy.hp/enemy.hpMax)*100;
        const een = (enemy.en/enemy.enMax)*100;

        $("hHpBar").style.width = hhp + "%";
        $("hEnBar").style.width = hen + "%";
        $("eHpBar").style.width = ehp + "%";
        $("eEnBar").style.width = een + "%";

        $("hShBar").style.width = clamp(hero.shield,0,40)/40*100 + "%";
        $("eShBar").style.width = clamp(enemy.shield,0,40)/40*100 + "%";

        $("hHpTxt").textContent = `${hero.hp}/${hero.hpMax}`;
        $("hEnTxt").textContent = `${hero.en}/${hero.enMax}`;
        $("hShTxt").textContent = `${hero.shield}`;

        $("eHpTxt").textContent = `${enemy.hp}/${enemy.hpMax}`;
        $("eEnTxt").textContent = `${enemy.en}/${enemy.enMax}`;
        $("eShTxt").textContent = `${enemy.shield}`;

        const canAct = battleOn && heroTurn && hero.hp > 0 && enemy.hp > 0;
        $("actAttack").disabled = !canAct;
        $("actSkill").disabled  = !canAct || hero.en < 12;
        $("actHeal").disabled   = !canAct || hero.en < 10;
        $("actDefend").disabled = !canAct;

        $("turnHint").textContent =
          !battleOn ? "Press START BATTLE INIT to begin."
          : (heroTurn ? "Your turn. Pick an action." : "Enemy turn...");
      }

      function dealDamage(target, raw){
        const blocked = Math.min(target.shield, raw);
        target.shield -= blocked;
        const dmg = raw - blocked;
        target.hp = clamp(target.hp - dmg, 0, target.hpMax);
        return { dmg, blocked };
      }
      function critify(base, critChance){
        if(chance(critChance)){
          return { amount: Math.round(base*1.6), crit:true };
        }
        return { amount: base, crit:false };
      }

      function endBattle(win){
        battleOn = false;
        if(win){
          log("WIN", `Victory! You gained <b>+12 XP</b> and <b>+10 power</b>.`);
          addXP(12);
          setPower(power + 10);
          showToast("WIN! üèÜ");
        } else {
          log("LOSE", "Defeat üòÖ Try again! (+3 XP consolation)");
          addXP(3);
          showToast("Defeat üòÖ");
        }
        updateBattleUI();
      }

      function enemyTurn(){
        heroTurn = false;
        updateBattleUI();

        setTimeout(() => {
          if(!battleOn) return;
          // Simple AI: use skill if energy, heal if low, else attack
          if(enemy.hp < enemy.hpMax*0.35 && enemy.en >= 10 && chance(0.55)){
            enemy.en -= 10;
            const heal = rnd(12, 20);
            enemy.hp = clamp(enemy.hp + heal, 0, enemy.hpMax);
            log("ENEMY", `${enemy.name} heals <b>+${heal}</b>.`);
          } else if(enemy.en >= 12 && chance(0.45)){
            enemy.en -= 12;
            const base = enemy.skl + rnd(0,6);
            const c = critify(base, 0.10);
            const r = dealDamage(hero, c.amount);
            log("ENEMY", `${enemy.name} uses SKILL for <b>${r.dmg}</b>${r.blocked?` (blocked ${r.blocked})`:``}${c.crit?` <span class="tag">CRIT!</span>`:``}.`);
          } else {
            const base = enemy.atk + rnd(-2,3);
            const c = critify(base, 0.08);
            const r = dealDamage(hero, c.amount);
            log("ENEMY", `${enemy.name} attacks for <b>${r.dmg}</b>${r.blocked?` (blocked ${r.blocked})`:``}${c.crit?` <span class="tag">CRIT!</span>`:``}.`);
          }

          // regen a bit
          enemy.en = clamp(enemy.en + 4, 0, enemy.enMax);

          if(hero.hp <= 0) { endBattle(false); return; }
          heroTurn = true;
          updateBattleUI();
        }, 650);
      }

      function startBattle(){
        logEl.innerHTML = "";
        hero = buildHero();
        enemy = buildEnemy(rand(enemies));
        heroTurn = true;
        battleOn = true;
        heroFocus = 0;

        log("INIT", `Battle started! <b>${hero.cls}</b> vs <b>${enemy.name}</b>.`);
        updateBattleUI();
        showToast("Battle Init!");
      }

      $("btnStartBattle").addEventListener("click", () => startBattle());
      $("btnNewEnemy").addEventListener("click", () => {
        if(!enemy) enemy = buildEnemy(rand(enemies));
        else enemy = buildEnemy(rand(enemies));
        $("eIcon").textContent = enemy.icon;
        $("eName").textContent = enemy.name;
        showToast("Enemy changed!");
        updateBattleUI();
      });

      function pickClass(key){
        currentClass = key;
        hero = buildHero();
        $("heroIcon").textContent = hero.icon;
        $("heroClass").textContent = hero.cls;
        showToast("Class selected!");
        updateBattleUI();
      }
      $("pickStriker").addEventListener("click", ()=>pickClass("striker"));
      $("pickMage").addEventListener("click", ()=>pickClass("mage"));
      $("pickBuilder").addEventListener("click", ()=>pickClass("builder"));

      function heroAction(type){
        if(!battleOn || !heroTurn) return;

        if(type === "attack"){
          const base = hero.atkBase + rnd(-2,4);
          const c = critify(base, 0.10 + heroFocus*0.06);
          heroFocus = 0;
          const r = dealDamage(enemy, c.amount);
          log("YOU", `Attack for <b>${r.d
